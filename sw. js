<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sourav Surfers</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#ff6666">

<style>
body{
  margin:0;
  background:#111;
  color:white;
  font-family:Arial, sans-serif;
  overflow:hidden;
}
#game{
  position:relative;
  width:100vw;
  height:100vh;
  background:#1b1b1b;
  overflow:hidden;
}
.track{
  position:absolute;
  width:33.33%;
  height:100%;
  border-left:2px dashed #444;
}
.track:nth-child(1){left:0}
.track:nth-child(2){left:33.33%}
.track:nth-child(3){left:66.66%}

#player,#powerAvatar{
  position:absolute;
  bottom:80px;
  font-size:42px;
  transition:0.15s;
}
.item{
  position:absolute;
  font-size:30px;
}

#hud{
  position:absolute;
  top:10px;
  left:10px;
  z-index:5;
}

#visitorCounter{
  position:absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  font-size:26px;
  color:#ffcc00;
  font-weight:bold;
}

#menu{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,0.85);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  z-index:999;
}
button{
  padding:12px 20px;
  margin:6px;
  font-size:16px;
}
.hidden{display:none}

#installBanner{
  position:fixed;
  bottom:15px;
  left:50%;
  transform:translateX(-50%);
  background:#ff6666;
  padding:10px 16px;
  border-radius:10px;
  display:none;
  font-weight:bold;
}
</style>
</head>

<body>

<div id="game">
  <div class="track"></div><div class="track"></div><div class="track"></div>

  <div id="player">ðŸ˜€</div>
  <div id="powerAvatar" class="hidden"></div>

  <div id="hud">
    Coins: <span id="coinText">0</span><br>
    Power: <span id="powerText">None</span>
  </div>

  <div id="visitorCounter">Players: --</div>

  <div id="menu">
    <h1>Sourav Surfers</h1>
    <p style="text-align:center">
      Creator: <b>Sourav Shan K</b><br>
      Helped by <b>ChatGPT</b>
    </p>
    <button onclick="startGame()">Start Game</button>
    <button onclick="openStore()">Store</button>
    <button onclick="redeemCode()">Redeem Code</button>
    <button onclick="adminLogin()">Admin Login</button>
    <button id="adminCoinsBtn" class="hidden" onclick="giveCoins(100000)">
      Give 100k Coins
    </button>
  </div>

  <div id="installBanner">
    Install Sourav Surfers
    <button onclick="installApp()">Install</button>
  </div>
</div>

<script>
/* ===== CORE STATE ===== */
let gameState="menu";
let lane=1,y=80,vy=0,jumping=false;
let items=[];
let coins=Number(localStorage.coins)||0;
let powerTimer=0;
let magnet=false,jetpack=false,doubleMoney=false;
let isAdmin=false;

/* ===== ELEMENTS ===== */
const player=document.getElementById("player");
const avatar=document.getElementById("powerAvatar");
const menu=document.getElementById("menu");
const coinText=document.getElementById("coinText");
const powerText=document.getElementById("powerText");
const counter=document.getElementById("visitorCounter");
coinText.innerText=coins;

/* ===== VISITOR COUNTER ===== */
fetch("https://api.countapi.xyz/hit/sourav-surfers/visits")
.then(r=>r.json()).then(d=>counter.innerText="Players: "+d.value)
.catch(()=>counter.innerText="Players: --");

/* ===== ADMIN ===== */
function adminLogin(){
  if(prompt("Enter admin code:")==="SOURAVADMIN"){
    isAdmin=true;
    alert("Admin enabled");
    document.getElementById("adminCoinsBtn").classList.remove("hidden");
  }else alert("Wrong code");
}
function giveCoins(n){
  if(!isAdmin)return;
  coins+=n;
  localStorage.coins=coins;
  coinText.innerText=coins;
}

/* ===== GAME START ===== */
function startGame(){
  menu.style.display="none";
  gameState="playing";
  resetGame();
  requestAnimationFrame(gameLoop);
  spawnLoop();
  startInstallTimer();
}

/* ===== RESET ===== */
function resetGame(){
  lane=1;y=80;vy=0;jumping=false;
  magnet=jetpack=doubleMoney=false;
  powerTimer=0;
  powerText.innerText="None";
  avatar.classList.add("hidden");
  player.classList.remove("hidden");
  items.forEach(i=>i.el.remove());
  items=[];
}

/* ===== CONTROLS ===== */
document.addEventListener("keydown",e=>{
  if(gameState!=="playing")return;
  if(e.key==="ArrowLeft"&&lane>0)lane--;
  if(e.key==="ArrowRight"&&lane<2)lane++;
  if(e.key==="ArrowUp"&&!jumping){
    vy=18;
    jumping=true;
  }
  updatePlayer();
});

function updatePlayer(){
  player.style.left=(lane*33.33+16)+"%";
  player.style.bottom=y+"px";
  avatar.style.left=player.style.left;
  avatar.style.bottom=player.style.bottom;
}

/* ===== GAME LOOP ===== */
function gameLoop(){
  if(gameState!=="playing")return;

  vy-=0.9;
  y+=vy;
  if(y<=80){y=80;vy=0;jumping=false;}
  updatePlayer();

  if(powerTimer>0){
    powerTimer--;
    powerText.innerText=Math.ceil(powerTimer/60);
    if(powerTimer===0){
      magnet=jetpack=doubleMoney=false;
      avatar.classList.add("hidden");
      player.classList.remove("hidden");
      powerText.innerText="None";
    }
  }

  items.forEach((it,i)=>{
    it.y-=6;
    it.el.style.bottom=it.y+"px";

    // MAGNET
    if(magnet && it.type==="coin"){
      it.lane=lane;
      it.el.style.left=(lane*33.33+16)+"%";
    }

    // COLLISION
    if(it.lane===lane && it.y<120){
      if(it.type==="coin"){
        coins+=doubleMoney?2:1;
        coinText.innerText=coins;
        localStorage.coins=coins;
        it.el.remove();items.splice(i,1);
      }
      if(it.type==="power"){
        activatePower(it.power,it.emoji);
        it.el.remove();items.splice(i,1);
      }
      if(it.type==="train" && !jetpack){
        if(y<120){ // ðŸ”¥ FIXED JUMP COLLISION
          gameOver();
        }
      }
    }
    if(it.y<0){it.el.remove();items.splice(i,1);}
  });

  requestAnimationFrame(gameLoop);
}

/* ===== GAME OVER ===== */
function gameOver(){
  gameState="menu";
  menu.style.display="flex";
}

/* ===== SPAWN ===== */
function spawnLoop(){
  if(gameState!=="playing")return;
  let l=Math.floor(Math.random()*3);
  let r=Math.random();
  if(r<0.5)spawn("coin","ðŸª™",l);
  if(r>0.85){
    let p=Math.random();
    if(p<0.33)spawn("power","ðŸ§²",l,"magnet");
    else if(p<0.66)spawn("power","ðŸš€",l,"jetpack");
    else spawn("power","ðŸ’°",l,"double");
  }
  if(r>0.6)spawn("train","ðŸš†",l);
  setTimeout(spawnLoop,700);
}

function spawn(type,emoji,lane,power){
  let el=document.createElement("div");
  el.className="item";
  el.innerText=emoji;
  el.style.left=(lane*33.33+16)+"%";
  el.style.bottom="100%";
  document.getElementById("game").appendChild(el);
  items.push({el,type,lane,y:window.innerHeight,power,emoji});
}

/* ===== POWER ===== */
function activatePower(p,e){
  powerTimer=600;
  powerText.innerText="10";
  player.classList.add("hidden");
  avatar.classList.remove("hidden");
  avatar.innerText=e;
  if(p==="magnet")magnet=true;
  if(p==="jetpack")jetpack=true;
  if(p==="double")doubleMoney=true;
}

/* ===== INSTALL PROMPT ===== */
let deferredPrompt;
window.addEventListener("beforeinstallprompt",e=>{
  e.preventDefault();
  deferredPrompt=e;
});

function startInstallTimer(){
  setTimeout(()=>{
    if(deferredPrompt){
      document.getElementById("installBanner").style.display="block";
    }
  },60000);
}

function installApp(){
  deferredPrompt.prompt();
}
</script>

</body>
</html>
